# Created by Goh Ee Sheng 2022, NYP FYPJ 2022 P4
# Supervisor: Dr Brandon Ooi

# Pre-requisite
# 1. Use on Ubuntu OS
# 2. Do create a 'extracted_samples' directory or you can edit the input_path & output_path folder at the end of the file

# Workflow summary:
# 1. Extract zipped folders with zipped subfolders 
# 2. Within the unzipped subfolders, unzipped sub-subfolders.
# 3. All unzipped folders will be extracted to output_path - 'extracted_samples'


import os, py7zr, zipfile, rarfile




def unzip_csit(input_path,output_path):
    list_of_files = {}
    path = input_path
    for (dirpath, dirnames, filenames) in os.walk(path):
        for filename in filenames:
            print(dirpath.split("/"))
            a = dirpath.split("/")[-1]
            print(a)
            if filename.endswith('.7z') or filename.endswith('.zip') or filename.endswith('.rar'):
                b = os.sep.join([dirpath, filename])
                list_of_files[b] = a


    for i in list_of_files:
        try:
            if i.endswith('.7z'):
                with py7zr.SevenZipFile(i, 'r', password='infected') as zip:
                    zip.extractall(path=output_path+list_of_files[i])
                # print(list_of_files[i],i)
            elif i.endswith('.zip'):
                with zipfile.ZipFile(i, 'r') as zip:
                    zip.extractall(path=output_path+list_of_files[i],pwd=b'infected')
            else:
                with rarfile.RarFile(i, 'r') as zip:
                    zip.extractall(path=output_path+list_of_files[i], pwd='infected')

        # Lazy exception clause (Forgot what was the specific exception I needed to catch)
        except:
            print(list_of_files[i], i, 'error')
            pass





if __name__ == '__main__':

    #
    unzip_csit("/home/javier/Desktop/CSIT_AI/malware_samples/Aasdfasfdsadf",
               "/home/javier/Desktop/CSIT_AI/extracted_samples/")

    print('Malware samples extracted succesfully')
